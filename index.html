<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Virtual School Demo</title>
  <style>
    body { font-family: system-ui, Arial, sans-serif; margin: 40px; }
    main { max-width: 780px; margin: auto; }
  </style>
</head>
<body>
  <main>
    <h1>Virtual School Demo</h1>
    <p>Test the EduSmartBot on this page.</p>
  </main>

  <!-- STEP 1: Initialize chatbase queue + register action BEFORE embed loads -->
  <script>
    (function() {
      // Initialize chatbase queue
      if (!window.chatbase || window.chatbase("getState") !== "initialized") {
        window.chatbase = (...args) => {
          if (!window.chatbase.q) window.chatbase.q = [];
          window.chatbase.q.push(args);
        };
        window.chatbase = new Proxy(window.chatbase, {
          get(target, prop) {
            if (prop === "q") return target.q;
            return (...args) => target(prop, ...args);
          }
        });
      }

      // Try BOTH registration methods
      const formSchema = {
        fields: [
          {
            name: 'full_name',
            label: 'Full Name',
            type: 'text',
            placeholder: 'Enter your full name',
            validation: { required: { value: true, message: 'Full name is required' } }
          },
          {
            name: 'email',
            label: 'Email',
            type: 'text',
            placeholder: 'you@example.com',
            validation: { required: { value: true, message: 'Email is required' } }
          },
          {
            name: 'phone',
            label: 'Phone (+CC…)',
            type: 'text',
            placeholder: 'e.g., +971501234567',
            validation: { required: { value: true, message: 'Phone number is required' } }
          },
          {
            name: 'program_interest',
            label: 'Target Program',
            type: 'text',
            placeholder: 'e.g., Business Administration',
            validation: { required: { value: true, message: 'Program is required' } }
          },
          {
            name: 'intake_month',
            label: 'Desired Intake',
            type: 'text',
            placeholder: 'e.g., Sep 2025',
            validation: { required: { value: true, message: 'Intake month is required' } }
          },
          {
            name: 'consent',
            label: 'I agree to be contacted by the admissions team',
            type: 'checkbox',
            validation: { required: { value: true, message: 'You must agree to be contacted' } }
          }
        ],
        submitButtonText: 'Submit Pre-Enrolment',
        successMessage: "Thanks! Our admissions team will contact you shortly.",
        errorMessage: 'Something went wrong. Please try again.'
      };

      // Method 1: registerFormSchema (as object map with async function)
      try {
        window.chatbase.registerFormSchema({
          pre_enrolment_form: async (args, user) => {
            console.log('[chatbase] registerFormSchema triggered:', args, user);
            return formSchema;
          }
        });
        console.log('[chatbase] ✅ registerFormSchema queued');
      } catch (e) {
        console.error('[chatbase] registerFormSchema failed:', e);
      }

      // Method 2: registerAction (alternative API)
      try {
        window.chatbase.registerAction({
          pre_enrolment_form: async (args, user) => {
            console.log('[chatbase] registerAction triggered:', args, user);
            return formSchema;
          }
        });
        console.log('[chatbase] ✅ registerAction queued');
      } catch (e) {
        console.error('[chatbase] registerAction failed:', e);
      }

      // Method 3: on('action') event listener
      try {
        window.chatbase.on('action', (action) => {
          console.log('[chatbase] Action event received:', action);
          if (action.name === 'pre_enrolment_form') {
            return formSchema;
          }
        });
        console.log('[chatbase] ✅ action listener queued');
      } catch (e) {
        console.error('[chatbase] on action failed:', e);
      }

    })();
  </script>

  <!-- STEP 2: Chatbase config -->
  <script>
    window.embeddedChatbotConfig = {
      chatbotId: "XVyXRXhG6vCPUR_KFObQL",
      domain: "www.chatbase.co"
    };
  </script>

  <!-- STEP 3: Load embed -->
  <script
    src="https://www.chatbase.co/embed.min.js"
    chatbotId="XVyXRXhG6vCPUR_KFObQL"
    domain="www.chatbase.co"
    defer>
  </script>

  <!-- STEP 4: Debug after load -->
  <script>
    window.addEventListener('load', () => {
      setTimeout(() => {
        console.log('[debug] window.chatbase:', window.chatbase);
        console.log('[debug] chatbase.q:', window.chatbase?.q);
        
        // Check what methods are available
        if (typeof window.chatbase === 'function') {
          console.log('[debug] Available chatbase methods:');
          for (let key in window.chatbase) {
            console.log('  -', key, typeof window.chatbase[key]);
          }
        }
      }, 3000);
    });
  </script>
</body>
</html>
